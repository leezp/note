/*
Copyright 2013, KISSY v1.41
MIT Licensed
build time: Dec 4 22:17
*/
KISSY.add("promise",[],function(k){function t(a){"undefined"!==typeof console&&console.error&&console.error(a)}function o(a,b,d){if(a instanceof g)p(function(){d.call(a,a[e])});else{var l=a[e],c=a[i];c?c.push([b,d]):m(l)?o(l,b,d):b&&p(function(){b.call(a,l)})}}function f(a){if(!(this instanceof f))return new f(a);this.promise=a||new c;this.promise.defer=this}function m(a){return a&&a instanceof c}function c(a){this[e]=a;void 0===a&&(this[i]=[],this[n]=[])}function g(a){if(a instanceof g)return a;
c.apply(this,arguments);this[e]instanceof c&&"assert.not(this.__promise_value instanceof promise) in Reject constructor";return this}function j(a,b,d){function l(a){try{return b?b.call(this,a):a}catch(d){return t(d.stack||d),new g(d)}}function e(a){try{return d?d.call(this,a):new g(a)}catch(b){return t(b.stack||b),new g(b)}}function u(a){h?"already done at fulfilled":a instanceof c?"assert.not(value instanceof Promise) in when":(h=1,q.resolve(l.call(this,a)))}var q=new f,h=0;a instanceof c?o(a,u,
function(a){h?"already done at rejected":(h=1,q.resolve(e.call(this,a)))}):u(a);return q.promise}function r(a){return!s(a)&&m(a)&&void 0===a[i]&&(!m(a[e])||r(a[e]))}function s(a){return m(a)&&void 0===a[i]&&a[e]instanceof g}var e="__promise_value",p=k.setImmediate,n="__promise_progress_listeners",i="__promise_pendings";f.prototype={constructor:f,resolve:function(a){var b=this.promise,d;if(!(d=b[i]))return null;b[e]=a;d=[].concat(d);b[i]=void 0;b[n]=void 0;k.each(d,function(a){o(b,a[0],a[1])});return a},
reject:function(a){return this.resolve(new g(a))},notify:function(a){k.each(this.promise[n],function(b){p(function(){b(a)})})}};c.prototype={constructor:c,then:function(a,b,d){d&&this.progress(d);return j(this,a,b)},progress:function(a){this[n]&&this[n].push(a);return this},fail:function(a){return j(this,0,a)},fin:function(a){return j(this,function(b){return a(b,!0)},function(b){return a(b,!1)})},done:function(a,b){(a||b?this.then(a,b):this).fail(function(a){a.stack||a;"error";setTimeout(function(){throw a;
},0)})},isResolved:function(){return r(this)},isRejected:function(){return s(this)}};k.extend(g,c);KISSY.Defer=f;KISSY.Promise=c;c.Defer=f;k.mix(c,{when:j,isPromise:m,isResolved:r,isRejected:s,all:function(a){var b=a.length;if(!b)return null;for(var d=new f,c=0;c<a.length;c++)(function(c,e){j(c,function(c){a[e]=c;0===--b&&d.resolve(a)},function(a){d.reject(a)})})(a[c],c);return d.promise},async:function(a){return function(){function b(a,b){var h;try{h=f[a](b)}catch(i){return new g(i)}return h.done?
h.value:j(h.value,c,e)}function c(a){return b("next",a)}function e(a){return b("throw",a)}var f=a.apply(this,arguments);return c()}}});return c});
